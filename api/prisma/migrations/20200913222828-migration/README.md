# Migration `20200913222828-migration`

This migration has been generated by nampdn at 9/14/2020, 5:28:28 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE `camp_dev`.`Activity` DROP FOREIGN KEY `Activity_ibfk_1`

ALTER TABLE `camp_dev`.`Attendance` DROP FOREIGN KEY `Attendance_ibfk_1`

ALTER TABLE `camp_dev`.`Attendance` DROP FOREIGN KEY `Attendance_ibfk_2`

ALTER TABLE `camp_dev`.`Group` DROP FOREIGN KEY `Group_ibfk_1`

ALTER TABLE `camp_dev`.`Group` DROP FOREIGN KEY `Group_ibfk_2`

ALTER TABLE `camp_dev`.`GroupEnrollment` DROP FOREIGN KEY `GroupEnrollment_ibfk_1`

ALTER TABLE `camp_dev`.`GroupEnrollment` DROP FOREIGN KEY `GroupEnrollment_ibfk_2`

ALTER TABLE `camp_dev`.`Profile` DROP FOREIGN KEY `Profile_ibfk_1`

ALTER TABLE `camp_dev`.`ReportCampaign` DROP FOREIGN KEY `ReportCampaign_ibfk_1`

ALTER TABLE `camp_dev`.`ReportInGroup` DROP FOREIGN KEY `ReportInGroup_ibfk_1`

ALTER TABLE `camp_dev`.`ReportQuestion` DROP FOREIGN KEY `ReportQuestion_ibfk_1`

ALTER TABLE `camp_dev`.`Schedule` DROP FOREIGN KEY `Schedule_ibfk_1`

ALTER TABLE `camp_dev`.`User` DROP FOREIGN KEY `User_ibfk_1`

ALTER TABLE `camp_dev`.`_AttendanceAbsentee` DROP FOREIGN KEY `_AttendanceAbsentee_ibfk_1`

ALTER TABLE `camp_dev`.`_AttendanceAbsentee` DROP FOREIGN KEY `_AttendanceAbsentee_ibfk_2`

ALTER TABLE `camp_dev`.`_AttendanceAttendee` DROP FOREIGN KEY `_AttendanceAttendee_ibfk_1`

ALTER TABLE `camp_dev`.`_AttendanceAttendee` DROP FOREIGN KEY `_AttendanceAttendee_ibfk_2`

ALTER TABLE `camp_dev`.`_GroupMembers` DROP FOREIGN KEY `_GroupMembers_ibfk_1`

ALTER TABLE `camp_dev`.`_GroupMembers` DROP FOREIGN KEY `_GroupMembers_ibfk_2`

CREATE TABLE `camp_dev`.`ContainerType` (
`id` varchar(191) NOT NULL ,
`slug` varchar(191) NOT NULL ,
`name` varchar(191) NOT NULL ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `camp_dev`.`ContainerHost` (
`id` varchar(191) NOT NULL ,
`name` varchar(191) NOT NULL ,
`contact` varchar(191)  ,
`note` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `camp_dev`.`Container` (
`id` varchar(191) NOT NULL ,
`name` varchar(191) NOT NULL ,
`note` varchar(191)  ,
`capacity` int  DEFAULT 0,
`updatedAt` datetime(3) NOT NULL ,
`createdAt` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
`containerTypeId` varchar(191) NOT NULL ,
`containerHostId` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `camp_dev`.`ContainerRole` (
`id` varchar(191) NOT NULL ,
`name` varchar(191) NOT NULL ,
`containerId` varchar(191)  ,
`profileId` varchar(191)  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `camp_dev`.`ProfilesOnContainers` (
`containerId` varchar(191) NOT NULL ,
`profileId` varchar(191) NOT NULL ,
`note` varchar(191)  ,
`createdAt` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
PRIMARY KEY (`containerId`,`profileId`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

ALTER TABLE `camp_dev`.`DraftProfile` ADD COLUMN `activated` boolean NOT NULL DEFAULT true;

CREATE UNIQUE INDEX `ContainerType.slug_unique` ON `camp_dev`.`ContainerType`(`slug`)

ALTER TABLE `camp_dev`.`Container` ADD FOREIGN KEY (`containerHostId`) REFERENCES `camp_dev`.`ContainerHost`(`id`) ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE `camp_dev`.`Container` ADD FOREIGN KEY (`containerTypeId`) REFERENCES `camp_dev`.`ContainerType`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `camp_dev`.`ContainerRole` ADD FOREIGN KEY (`containerId`, `profileId`) REFERENCES `camp_dev`.`ProfilesOnContainers`(`containerId`,`profileId`) ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE `camp_dev`.`ProfilesOnContainers` ADD FOREIGN KEY (`containerId`) REFERENCES `camp_dev`.`Container`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `camp_dev`.`ProfilesOnContainers` ADD FOREIGN KEY (`profileId`) REFERENCES `camp_dev`.`DraftProfile`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE `camp_dev`.`Activity`;

DROP TABLE `camp_dev`.`Attendance`;

DROP TABLE `camp_dev`.`Group`;

DROP TABLE `camp_dev`.`GroupEnrollment`;

DROP TABLE `camp_dev`.`Org`;

DROP TABLE `camp_dev`.`Profile`;

DROP TABLE `camp_dev`.`ReportCampaign`;

DROP TABLE `camp_dev`.`ReportInGroup`;

DROP TABLE `camp_dev`.`ReportQuestion`;

DROP TABLE `camp_dev`.`Schedule`;

DROP TABLE `camp_dev`.`User`;

DROP TABLE `camp_dev`.`_AttendanceAbsentee`;

DROP TABLE `camp_dev`.`_AttendanceAttendee`;

DROP TABLE `camp_dev`.`_GroupMembers`;
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200828005843-migration..20200913222828-migration
--- datamodel.dml
+++ datamodel.dml
@@ -1,24 +1,14 @@
 datasource DS {
   provider = "mysql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider      = "prisma-client-js"
   binaryTargets = env("BINARY_TARGET")
 }
-model User {
-  id         String  @default(cuid()) @id
-  email      String  @unique
-  password   String
-  permission Int
-  name       String?
-  profile    Profile @relation("UserProfile", fields: [profileId], references: [id])
-  profileId  String
-}
-
 model Meta {
   id             String        @default(cuid()) @id
   key            String
   value          String
@@ -27,129 +17,62 @@
   draftProfileId String?
 }
 model DraftProfile {
-  id          String    @default(cuid()) @id
+  id          String                 @default(cuid()) @id
   fullName    String
   nationalId  String?
   phoneNumber String?
   birthday    DateTime?
   meta        Meta[]
-  createdAt   DateTime  @default(now())
+  activated   Boolean                @default(value: true)
+  createdAt   DateTime               @default(now())
+  containers  ProfilesOnContainers[]
 }
-model Profile {
-  id           String            @default(cuid()) @id
-  fullName     String
-  gender       String?
-  oldId        String?           @unique
-  slug         String?           @unique
-  email        String?
-  facebookId   String?
-  phoneNumber  String?
-  birthday     DateTime?
-  joinDate     DateTime?
-  dayOfBirth   Int?
-  monthOfBirth Int?
-  yearOfBirth  Int?
-  org          Org?              @relation("ProfileOrg", fields: [orgId], references: [id])
-  createdAt    DateTime          @default(now())
-  updatedAt    DateTime          @updatedAt
-  leader       Group[]           @relation("GroupLeader")
-  member       Group[]           @relation("GroupMembers", references: [id])
-  attendee     Attendance[]      @relation("AttendanceAttendee", references: [id])
-  absentee     Attendance[]      @relation("AttendanceAbsentee", references: [id])
-  orgId        String?
-  user         User[]            @relation("UserProfile")
-  enrollment   GroupEnrollment[]
+model ContainerType {
+  id         String      @default(cuid()) @id
+  slug       String      @unique
+  name       String
+  containers Container[]
 }
-model Group {
-  id            String            @default(cuid()) @id
-  name          String
-  slug          String?           @unique
-  year          Int?
-  stage         String?
-  members       Profile[]         @relation("GroupMembers", references: [id])
-  startAt       DateTime?
-  endAt         DateTime?
-  createdAt     DateTime          @default(now())
-  updatedAt     DateTime          @updatedAt @default(now())
-  leader        Profile?          @relation("GroupLeader", fields: [leaderId], references: [id])
-  leaderId      String?
-  org           Org?              @relation(fields: [orgId], references: [id])
-  orgId         String?
-  attendances   Attendance[]      @relation("AttendanceGroup")
-  enrollment    GroupEnrollment[]
-  ReportInGroup ReportInGroup[]   @relation("ReportGroup")
-}
-
-model GroupEnrollment {
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
-  group     Group    @relation(fields: [groupId], references: [id])
-  profile   Profile  @relation(fields: [profileId], references: [id])
-  groupId   String
-  profileId String
-
-  @@id([groupId, profileId])
-}
-
-model Org {
-  id         String     @default(cuid()) @id
+model ContainerHost {
+  id         String      @default(cuid()) @id
   name       String
-  groups     Group[]
-  activities Activity[] @relation("OrgActivity")
-  Profile    Profile[]  @relation("ProfileOrg")
+  contact    String?
+  note       String?
+  containers Container[]
 }
-model Activity {
-  id       String     @default(cuid()) @id
-  slug     String     @unique
-  name     String
-  color    String?
-  org      Org        @relation("OrgActivity", fields: [orgId], references: [id])
-  orgId    String
-  Schedule Schedule[] @relation("ScheduleActivity")
+model Container {
+  id              String                 @default(cuid()) @id
+  name            String
+  note            String?
+  profiles        ProfilesOnContainers[]
+  host            ContainerHost?         @relation(fields: [containerHostId], references: [id])
+  type            ContainerType          @relation(fields: [containerTypeId], references: [id])
+  capacity        Int?                   @default(value: 0)
+  updatedAt       DateTime               @updatedAt
+  createdAt       DateTime               @default(now())
+  containerTypeId String
+  containerHostId String?
 }
-model Schedule {
-  id          String       @default(cuid()) @id
-  attendances Attendance[] @relation("AttendanceSchedule")
-  date        DateTime
-  activity    Activity     @relation("ScheduleActivity", fields: [activityId], references: [id])
-  activityId  String
+model ContainerRole {
+  id          String                @default(cuid()) @id
+  name        String
+  container   ProfilesOnContainers? @relation(fields: [containerId, profileId], references: [containerId, profileId])
+  containerId String?
+  profileId   String?
 }
-model Attendance {
-  id         String    @default(cuid()) @id
-  slug       String    @unique
-  status     String
-  createdAt  DateTime  @default(now())
-  updatedAt  DateTime  @updatedAt
-  group      Group     @relation("AttendanceGroup", fields: [groupId], references: [id])
-  schedule   Schedule  @relation("AttendanceSchedule", fields: [scheduleId], references: [id])
-  attendees  Profile[] @relation("AttendanceAttendee", references: [id])
-  absentees  Profile[] @relation("AttendanceAbsentee", references: [id])
-  groupId    String
-  scheduleId String
+model ProfilesOnContainers {
+  container   Container       @relation(fields: [containerId], references: [id])
+  containerId String
+  profile     DraftProfile    @relation(fields: [profileId], references: [id])
+  profileId   String
+  role        ContainerRole[]
+  note        String?
+  createdAt   DateTime        @default(now())
+  @@id([containerId, profileId])
 }
-
-model ReportQuestion {
-  id       String         @default(cuid()) @id
-  type     String
-  content  String
-  campaign ReportCampaign @relation("ReportCampaignQuestions", fields: [id], references: [id])
-}
-
-model ReportCampaign {
-  id        String           @default(cuid()) @id
-  date      DateTime
-  questions ReportQuestion[] @relation("ReportCampaignQuestions")
-  report    ReportInGroup    @relation("ReportCampaign", fields: [id])
-}
-
-model ReportInGroup {
-  id       String         @default(cuid()) @id
-  group    Group          @relation("ReportGroup", fields: [id])
-  campaign ReportCampaign @relation("ReportCampaign")
-}
```


